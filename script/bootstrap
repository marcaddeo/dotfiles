#!/bin/bash
## This script is intended to bootstrap a freshly installed copy of OS X to get
## up and running with my development environment
##
## Tested on OS X 10.11 El Capitan
DOTFILES="$HOME/dotfiles"

## Install software

# Authenticate sudo
sudo -v

# Install homebrew
yes | ruby -e "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)"

# Tap homebrew/dupes
brew tap homebrew/dupes

# Get the latest git
brew install git

# Clone my dotfiles
git clone --recursive https://github.com/marcaddeo/dotfiles.git $DOTFILES

# Install Zsh
brew install zsh
echo $(which zsh) | sudo tee -a /etc/shells; chsh -s $(which zsh)

# Install the gnu coreutils so we can use dircolors as gdircolors
brew install coreutils

# Install fzf
brew reinstall --HEAD fzf
yes | /usr/local/opt/fzf/install

# Install pip
sudo easy_install pip

# Install neovim
brew tap neovim/neovim
brew install --HEAD neovim
pip2 install --user neovim

# Install tmux
brew install tmux

# Install keybase
brew install keybase

# Create the ~/.gnupg directory if it doesn't exist
if [[ ! -d $HOME/.gnupg ]]; then
    mkdir $HOME/.gnupg
fi

# Login to keybase but don't pull keys
# Pulling keys will fail on login, because my key and loging passphrase are
# different
keybase login --no-key-pull
# Actually pull down my keys in a separate transaction so I can use the proper
# passphrase
keybase pull

# Create the ~/.ssh directory if it doesn't exist
if [[ ! -d $HOME/.ssh ]]; then
    mkdir $HOME/.ssh
fi

# Decrypt and copy ssh keys
keybase decrypt -S marcaddeo -o $HOME/.ssh/id_rsa.github $DOTFILES/ssh/id_rsa.github.asc
chmod 600 $HOME/.ssh/id_rsa.github
ssh-keygen -y -f $HOME/.ssh/id_rsa.github > $HOME/.ssh/id_rsa.github.pub

# Switch the dotfiles repository to an ssh origin
pushd .

cd $DOTFILES
git remote remove origin
git remote add origin git@github.com:marcaddeo/dotfiles.git
yes | git fetch
git branch master --set-upstream-to origin/master

popd

## Install applications

# Install homebrew cask
brew install caskroom/cask/brew-cask

## Set sensible OS X defaults

# Remove the [ mark from the terminal
defaults write com.apple.Terminal AutoMarkPromptLines -int 0

## Install symlinks
$DOTFILES/script/install
